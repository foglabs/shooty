<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Shooty Blasters</title>
    <link href="game.css" rel="stylesheet">
  </head>

  <body>
    <div id="info" class="info-bar">
      <div class="bar-ele" id="score"></div>
      <div class="bar-ele-wide">
        <progress id="power" value="00" max="100"></progress>
      </div>

      <div class="bar-ele" id="timer"></div>
    </div>

    <div id="info2" class="info-bar">
      <div class="bar-ele" id="level">1</div>

      <div class="bar-ele-wide">
        <progress id="health" value="100" max="100"></progress>
      </div>

      <div class="bar-ele" id="bombs"></div>
    </div>

    <div id="info3" class="info-bar">
      <div class="bar-ele-wide">
        <progress id="knowledge" value="0" max="100"></progress>
      </div>
    </div>

    <div id="stage-info"></div>

    <script type="text/javascript">
      function lerp(a, b, u) {
        // start val, dest val, interval
        return (1 - u) * a + u * b;
      }

      function rgbToHex(r,g,b){
        return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b)
      }

      function componentToHex(c) {
        c = c < 255 ? c : 255 
        var hex = c.toString(16)
        return hex.length == 1 ? "0" + hex : hex
      }

      function incInRange(val, inc, min, max){
        return Math.min( Math.max( val+inc, min ), max )
      }

      function rotateInc(inc, currentRotation){
        // use radians because js stands for jradianscript
        let result = currentRotation + inc
        if(result >= DEG360){
          result = result - DEG360
        } else if(result < 0){
          result = result + DEG360
        }

        return result
      }

      function rotateToward(current, destination, amount){
        if(current == destination){
          // dont do shit if its already BEEN rotated
          return current
        }

        let sign
        if(current > destination){
          sign = (current - DEG360 - destination) > (current - destination) ? 1 : -1
        } else {
          sign = (destination - current) > (destination - DEG360 - current) ? 1 : -1
        }

        return rotateInc(sign*amount, current)
      }

      function isWithin(val, test, precision){
        // I dont give two fucks!
        precision = Math.abs(precision)
       return val < test+precision && val > test-precision
      }

      function radian(deg){
        return Math.PI/180*deg
      }

    </script>

    <script src="three.js"></script>
    <script src="classes/keyHandler.js"></script>
    <script src="classes/sound.js"></script>
    <script src="classes/music.js"></script>
    <script src="classes/game.js"></script>
    <script src="classes/timer.js"></script>
    <script src="classes/duster.js"></script>
    <script src="classes/character.js"></script>
    <script src="classes/player.js"></script>
    <script src="classes/enemy.js"></script>
    <script src="classes/bomb.js"></script>
    <script src="classes/sword.js"></script>
    <script>

      LEFT = 0
      UP = 1
      RIGHT = 2
      DOWN = 3

      // char lifecycle
      ALIVE = 0
      DYING = 1
      DEAD = 2

      // game stage
      TITLE = 0
      LOADING = 1
      PLAYING = 2
      ENDING = 3
      GAMEOVER = 4

      // enemy type
      SPHERE = 0
      STICK = 1
      CIRCLE = 2
      KNOWLOCTA = 3
      HEALCUBE = 4

      // DEG0 = radian(0)
      DEG1 = radian(1)
      DEG45 = radian(45)
      DEG90 = radian(90)
      DEG135 = radian(135)
      DEG180 = radian(180)
      DEG225 = radian(225)
      DEG270 = radian(270)
      DEG315 = radian(315)
      DEG360 = radian(360)

      function checkSoundsLoaded(){
        let done = true
        !fx_ekill1.loaded ? done = false : null
        !fx_ekill2.loaded ? done = false : null
        !fx_ekill3.loaded ? done = false : null
        !fx_ekill4.loaded ? done = false : null
        !fx_ekill5.loaded ? done = false : null
        !fx_ekill6.loaded ? done = false : null
        !fx_edmg1.loaded ? done = false : null
        !fx_edmg2.loaded ? done = false : null
        !fx_edmg3.loaded ? done = false : null
        !fx_edmg4.loaded ? done = false : null
        !fx_edmg5.loaded ? done = false : null
        !fx_ckill1.loaded ? done = false : null
        !fx_ckill2.loaded ? done = false : null
        !fx_ckill3.loaded ? done = false : null
        !fx_phealth1.loaded ? done = false : null
        !fx_phealth2.loaded ? done = false : null
        !fx_phealth3.loaded ? done = false : null
        !fx_youredeadE.loaded ? done = false : null
        !fx_levelupE2.loaded ? done = false : null
        !fx_startgameE.loaded ? done = false : null
        !fx_song2.loaded ? done = false : null
        return done
      }

      // run every frame
      function animate() {

        game.handleGame()
        // console.log( 'TEMPS', keyHandler.keyHeats )
        // console.log( 'HELD', keyHandler.heldKeys )
        keyHandler.handleKeyTemp()

        requestAnimationFrame( animate )
        // draw de cool scene
        renderer.render( scene, camera )
        // clear de buff
        // for the HUD
        renderer.render(sceneHUD, cameraHUD)
      }

      let listener = new THREE.AudioListener()
      let audioLoader = new THREE.AudioLoader()

      let fx_ekill1 = new Sound("sounds/ekill1.wav")
      let fx_ekill2 = new Sound("sounds/ekill2.wav")
      let fx_ekill3 = new Sound("sounds/ekill3.wav")
      let fx_ekill4 = new Sound("sounds/ekill4.wav")
      let fx_ekill5 = new Sound("sounds/ekill5.wav")
      let fx_ekill6 = new Sound("sounds/ekill6.wav")
      let fx_edmg1 = new Sound("sounds/edmg1.wav")
      let fx_edmg2 = new Sound("sounds/edmg2.wav")
      let fx_edmg3 = new Sound("sounds/edmg3.wav")
      let fx_edmg4 = new Sound("sounds/edmg4.wav")
      let fx_edmg5 = new Sound("sounds/edmg5.wav")
      let fx_ckill1 = new Sound("sounds/ckill1.wav")
      let fx_ckill2 = new Sound("sounds/ckill2.wav")
      let fx_ckill3 = new Sound("sounds/ckill3.wav")
      let fx_phealth1 = new Sound("sounds/phealth1.wav")
      let fx_phealth2 = new Sound("sounds/phealth2.wav")
      let fx_phealth3 = new Sound("sounds/phealth3.wav")
      let fx_youredeadE = new Sound("sounds/youredeadE.wav", 0.8)
      let fx_levelupE2 = new Sound("sounds/levelupE2.wav", 0.8)
      let fx_startgameE = new Sound("sounds/startgameE.wav", 0.8)
      let fx_song2 = new Music("sounds/song2.wav", 0.8)


      // scene contains objects
      var scene = new THREE.Scene();


      // load this crap here so we only do it once
      let bloodspriteMaterial
      let loader = new THREE.TextureLoader()

      let bloodspriteMap = loader.load( "sprites/bloodsprite.png")
      bloodspriteMaterial = new THREE.SpriteMaterial( { map: bloodspriteMap } )
      let corruptorMatMap = new THREE.TextureLoader().load("sprites/corruptsprite.png")
      let corruptorMaterial = new THREE.SpriteMaterial( { map: corruptorMatMap } )
      // we pass this in to select
      let pointMatMap = new THREE.TextureLoader().load("sprites/pointsprite.png")
      let pbloodspriteMap = loader.load( "sprites/playerblood.png")
      let pbloodspriteMaterial = new THREE.SpriteMaterial( { map: bloodspriteMap } )
      let healthenemyMap = loader.load( "sprites/healthenemy.png")
      let healthenemyMaterial = new THREE.SpriteMaterial( { map: healthenemyMap } )

      // camera is passed into renderer, rather than as scene object
      var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 )
      camera.position.z = 5

      // this is for the gui
      let width = window.innerWidth
      let height = window.innerHeight

      let hudCanvas = document.createElement('canvas')
      hudCanvas.width = width
      hudCanvas.height = height
      let hudBitmap = hudCanvas.getContext('2d');
      // hudBitmap.font = "Normal 40px Arial";
      // hudBitmap.bottom = 0
      // hudBitmap.textAlign = 'center';
      // hudBitmap.fillStyle = "rgba(245,245,245,0.75)";
      // hudBitmap.fillText('0 0 0 0 0', width / 2, height-20);
      // let gr = hudBitmap.createRadialGradient(110,90,30, 100,100,70);
      // gr.addColorStop(0, 'pink');
      // gr.addColorStop(.9, 'white');
      // gr.addColorStop(1, 'green');
      // hudBitmap.fillStyle = gr
      
      var cameraHUD = new THREE.OrthographicCamera(-width/2, width/2, height/2, -height/2, 0, 30 );
      sceneHUD = new THREE.Scene();
      var hudTexture = new THREE.Texture(hudCanvas) 
      hudTexture.needsUpdate = true;
      var material = new THREE.MeshBasicMaterial( {map: hudTexture} );
      material.transparent = true;
      
      var planeGeometry = new THREE.PlaneGeometry( width, height );
      var plane = new THREE.Mesh( planeGeometry, material );
      sceneHUD.add( plane );

      let game = new Game()
      game.setBackgroundColor(game.backgroundColor[0],game.backgroundColor[1],game.backgroundColor[2])

      // let player = new Player([22,88,49])
      let player = new Player([0,88,255])
      player.mesh.visible = false
      scene.add( player.mesh )

      let duster = new Duster(pointMatMap, 0.2, 2000, 30)

      // create bounding box object for intersection

      // // add grid
      // var size = 10;
      // var divisions = 10;
      // var gridHelper = new THREE.GridHelper( size, divisions );
      // gridHelper.rotation.x = 80;
      // scene.add( gridHelper );

      // render has the beef (webgl) to draw each frame
      var renderer = new THREE.WebGLRenderer();
      renderer.autoClear = false
      renderer.setSize( window.innerWidth, window.innerHeight );
      // renderer.setClearColor( 0xffffff, 0 );

      // contain all those key bits
      let keyHandler = new KeyHandler()
      
      function onDocumentKeyDown(event) {
        keyHandler.heldKeys[event.key] = true

        if (event.key == " " || event.key == "Spacebar"){
          
          // SPACE BAR
          if(game.stage == TITLE || game.stage == GAMEOVER){
            if( checkSoundsLoaded() ){
              console.log( 'new game' )
              game.newGame()
            }

          } else if(game.stage == PLAYING){
            player.startKillingCircle()
          }
        } else if(event.key == "z"){
          player.dropBomb()
        } else if(event.key == "x"){
          if(player.swordEnabled){
            player.startSword()
          }
        }

      }
      function onDocumentKeyUp(event) {
        keyHandler.heldKeys[event.key] = false

        // clear out stuff from nonheld keys
        if(event.key == " " || event.key == "Spacebar"){
          player.stopKillingCircle()
        } else if(event.key == "x"){
          if(player.swordEnabled){
            player.stopSword()
          }
        }
      }
            
      // set listeners
      document.addEventListener("keydown", onDocumentKeyDown, false);
      document.addEventListener("keyup", onDocumentKeyUp, false);



      // put this here to get event context
      // function onDocumentKeyDownUp(event) {
        
      //   keyHandler.heldKeys[event.key] = event.type == 'keydown'
      //   let heldkeys_keys = Object.keys(keyHandler.heldKeys)

      //   // are any keys held down 
      //   if(heldkeys_keys){
      //     for(i=0; i<heldkeys_keys.length; i++){

      //       // is this particular key held down?
      //       let key = heldkeys_keys[ i ]

      //       if( keyHandler.heldKeys[ key ] ){

      //         keyHandler.keyEvents(event.key)
      //       }
      //     }
      //   }

      //   // clear out stuff from nonheld keys
      //   if(event.type == "keyup" && event.key == " " || event.key == "Spacebar"){
      //     player.stopKillingCircle()
      //   }

      //   console.log( 'type is ', event.type )
      //   console.log( 'keys is ', keyHandler.heldKeys )
      // }
      
      // set listeners
      // document.addEventListener("keydown", onDocumentKeyDownUp, false);
      // document.addEventListener("keyup", onDocumentKeyDownUp, false);
      

      animate();
      // document.addEventListener("keydown", onDocumentKeyDownUp, false);
      // document.addEventListener("keyup", onDocumentKeyDownUp, false);
      // function keyEvents(key){
      //   if (key == "ArrowLeft"){
      //       // console.log("left")
      //       player.accx -= 0.5;
      //   } else if (key == "ArrowUp"){
      //       // console.log("up")
      //       player.accy += 0.5
      //   } else if (key == "ArrowRight"){
      //       // console.log("right")
      //       player.accx += 0.5
      //   } else if (key == "ArrowDown"){
      //       // console.log("down")
      //       player.accy   -= 0.5
      //   } else if (key == " " || key == "Spacebar"){
          
      //     // SPACE BAR
      //     if(game.stage == TITLE){
      //       game.newGame()

      //     } else if(game.stage == PLAYING){
      //       player.startKillingCircle()
      //     }
      //   }
      // }

      // let heldkeys = {}
      // function onDocumentKeyDownUp(event) {
      //   heldkeys[event.key] = event.type == 'keydown'

      //   heldkeys_keys = Object.keys(heldkeys)

      //   // are any keys held down 
      //   if(heldkeys_keys){
      //     for(i=0; i<heldkeys_keys.length; i++){
      //       // is the key held down?
      //       let key = heldkeys_keys[i];
      //       if(heldkeys[key]){
      //         keyEvents(event.key)
      //       }
      //     }
      //   }

      //   // clear out stuff from nonheld keys
      //   if(event.type == "keyup" && event.key == " " || event.key == "Spacebar"){
      //     player.stopKillingCircle()
      //   }
      // }

      document.body.appendChild( renderer.domElement )
    </script>

  </body>
</html>

