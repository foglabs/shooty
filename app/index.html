<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Shooty Blasters</title>
    <link href="game.css" rel="stylesheet">
  </head>

  <body>
    <div id="info">
      <div class="bar-ele" id="score"></div>
      <div class="bar-ele">
        <progress id="power" value="00" max="100"></progress>
      </div>

      <div class="bar-ele" id="timer"></div>
    </div>

    <div id="info2">
      <div class="bar-ele">
        <progress id="health" value="100" max="100"></progress>
      </div>
    </div>

    <div id="stage-info">
      PRESS SPACEBAR
    </div>

    <script src="three.js"></script>
    <script src="classes/sound.js"></script>
    <script src="classes/game.js"></script>
    <script src="classes/timer.js"></script>
    <script src="classes/duster.js"></script>
    <script src="classes/character.js"></script>
    <script src="classes/player.js"></script>
    <script src="classes/enemy.js"></script>
    <script>
      LEFT = 0
      UP = 1
      RIGHT = 2
      DOWN = 3

      // char lifecycle
      ALIVE = 0
      DYING = 1
      DEAD = 2

      // game stage
      TITLE = 0
      LOADING = 1
      PLAYING = 2
      ENDING = 3
      GAMEOVER = 4

      // sound type
      FX = 0
      BGM = 1
      AMB = 2

      // run every frame
      function animate() {


        game.handleGame()

        requestAnimationFrame( animate )
        // draw de cool scene
        renderer.render( scene, camera )
        // clear de buff
        // for the HUD
        renderer.render(sceneHUD, cameraHUD)
      }

      // scene contains objects
      var scene = new THREE.Scene();


      // load this crap here so we only do it once
      let bloodspriteMaterial
      let loader = new THREE.TextureLoader()

      let bloodspriteMap = loader.load( "sprites/bloodsprite.png")
      bloodspriteMaterial = new THREE.SpriteMaterial( { map: bloodspriteMap } )
      let corruptorMatMap = new THREE.TextureLoader().load("sprites/corruptsprite.png")
      let corruptorMaterial = new THREE.SpriteMaterial( { map: corruptorMatMap } )
      // we pass this in to select
      let pointMatMap = new THREE.TextureLoader().load("sprites/pointsprite.png")
      let pbloodspriteMap = loader.load( "sprites/playerblood.png")
      let pbloodspriteMaterial = new THREE.SpriteMaterial( { map: bloodspriteMap } )
      let healthenemyMap = loader.load( "sprites/healthenemy.png")
      let healthenemyMaterial = new THREE.SpriteMaterial( { map: healthenemyMap } )

      // camera is passed into renderer, rather than as scene object
      var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 )
      camera.position.z = 5

      let listener = new THREE.AudioListener()
      let audioLoader = new THREE.AudioLoader()

      let ekill1 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill1.wav', function(buff) {
        ekill1.setBuffer( buff )
      })
      let fx_ekill1 = new Sound(ekill1)
      let ekill2 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill2.wav', function(buff) {
        ekill2.setBuffer( buff )
      })
      let fx_ekill2 = new Sound(ekill2)
      let ekill3 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill3.wav', function(buff) {
        ekill3.setBuffer( buff )
      })
      let fx_ekill3 = new Sound(ekill3)
      let ekill4 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill4.wav', function(buff) {
        ekill4.setBuffer( buff )
      })
      let fx_ekill4 = new Sound(ekill4)
      let ekill5 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill5.wav', function(buff) {
        ekill5.setBuffer( buff )
      })
      let fx_ekill5 = new Sound(ekill5)
      let ekill6 = new THREE.Audio(listener)
      audioLoader.load('sounds/ekill6.wav', function(buff) {
        ekill6.setBuffer( buff )
      })
      let fx_ekill6 = new Sound(ekill6)

      let edmg1 = new THREE.Audio(listener)
      audioLoader.load('sounds/edmg1.wav', function(buff) {
        edmg1.setBuffer( buff )
      })
      let fx_edmg1 = new Sound(edmg1)
      let edmg2 = new THREE.Audio(listener)
      audioLoader.load('sounds/edmg2.wav', function(buff) {
        edmg2.setBuffer( buff )
      })
      let fx_edmg2 = new Sound(edmg2)
      let edmg3 = new THREE.Audio(listener)
      audioLoader.load('sounds/edmg3.wav', function(buff) {
        edmg3.setBuffer( buff )
      })
      let fx_edmg3 = new Sound(edmg3)
      let edmg4 = new THREE.Audio(listener)
      audioLoader.load('sounds/edmg4.wav', function(buff) {
        edmg4.setBuffer( buff )
      })
      let fx_edmg4 = new Sound(edmg4)
      let edmg5 = new THREE.Audio(listener)
      audioLoader.load('sounds/edmg5.wav', function(buff) {
        edmg5.setBuffer( buff )
      })
      let fx_edmg5 = new Sound(edmg5)

      let ckill1 = new THREE.Audio(listener)
      audioLoader.load('sounds/ckill1.wav', function(buff) {
        ckill1.setBuffer( buff )
      })
      let fx_ckill1 = new Sound(ckill1)
      let ckill2 = new THREE.Audio(listener)
      audioLoader.load('sounds/ckill2.wav', function(buff) {
        ckill2.setBuffer( buff )
      })
      let fx_ckill2 = new Sound(ckill2)
      let ckill3 = new THREE.Audio(listener)
      audioLoader.load('sounds/ckill3.wav', function(buff) {
        ckill3.setBuffer( buff )
      })
      let fx_ckill3 = new Sound(ckill3)

      let phealth1 = new THREE.Audio(listener)
      audioLoader.load('sounds/phealth1.wav', function(buff) {
        phealth1.setBuffer( buff )
      })
      let fx_phealth1 = new Sound(phealth1)
      let phealth2 = new THREE.Audio(listener)
      audioLoader.load('sounds/phealth2.wav', function(buff) {
        phealth2.setBuffer( buff )
      })
      let fx_phealth2 = new Sound(phealth2)
      let phealth3 = new THREE.Audio(listener)
      audioLoader.load('sounds/phealth3.wav', function(buff) {
        phealth3.setBuffer( buff )
      })
      let fx_phealth3 = new Sound(phealth3)



      // this is for the gui
      let width = window.innerWidth
      let height = window.innerHeight

      let hudCanvas = document.createElement('canvas')
      hudCanvas.width = width
      hudCanvas.height = height
      let hudBitmap = hudCanvas.getContext('2d');
      // hudBitmap.font = "Normal 40px Arial";
      // hudBitmap.bottom = 0
      // hudBitmap.textAlign = 'center';
      // hudBitmap.fillStyle = "rgba(245,245,245,0.75)";
      // hudBitmap.fillText('0 0 0 0 0', width / 2, height-20);
      // let gr = hudBitmap.createRadialGradient(110,90,30, 100,100,70);
      // gr.addColorStop(0, 'pink');
      // gr.addColorStop(.9, 'white');
      // gr.addColorStop(1, 'green');
      // hudBitmap.fillStyle = gr
      
      var cameraHUD = new THREE.OrthographicCamera(-width/2, width/2, height/2, -height/2, 0, 30 );
      sceneHUD = new THREE.Scene();
      var hudTexture = new THREE.Texture(hudCanvas) 
      hudTexture.needsUpdate = true;
      var material = new THREE.MeshBasicMaterial( {map: hudTexture} );
      material.transparent = true;
      
      var planeGeometry = new THREE.PlaneGeometry( width, height );
      var plane = new THREE.Mesh( planeGeometry, material );
      sceneHUD.add( plane );

      let game = new Game()
      game.setBackgroundColor(game.backgroundColor[0],game.backgroundColor[1],game.backgroundColor[2])

      // let player = new Player([22,88,49])
      let player = new Player([0,88,255])
      player.mesh.visible = false
      scene.add( player.mesh )

      let duster = new Duster(pointMatMap, 0.2, 2000, 30)

      // create bounding box object for intersection

      // // add grid
      // var size = 10;
      // var divisions = 10;
      // var gridHelper = new THREE.GridHelper( size, divisions );
      // gridHelper.rotation.x = 80;
      // scene.add( gridHelper );

      // render has the beef (webgl) to draw each frame
      var renderer = new THREE.WebGLRenderer();
      renderer.autoClear = false
      renderer.setSize( window.innerWidth, window.innerHeight );
      // renderer.setClearColor( 0xffffff, 0 );

      animate();

      document.addEventListener("keydown", onDocumentKeyDownUp, false);
      document.addEventListener("keyup", onDocumentKeyDownUp, false);
      function keyEvents(key){
        if (key == "ArrowLeft"){
            // console.log("left")
            player.accx -= 0.5;
        } else if (key == "ArrowUp"){
            // console.log("up")
            player.accy += 0.5
        } else if (key == "ArrowRight"){
            // console.log("right")
            player.accx += 0.5
        } else if (key == "ArrowDown"){
            // console.log("down")
            player.accy   -= 0.5
        } else if (key == " " || key == "Spacebar"){
          
          // SPACE BAR
          if(game.stage == TITLE){
            game.newGame()

          } else if(game.stage == PLAYING){
            player.startKillingCircle()
          }
        }
      }

      let heldkeys = {};
      function onDocumentKeyDownUp(event) {
        heldkeys[event.key] = event.type == 'keydown';

        heldkeys_keys = Object.keys(heldkeys)

        // are any keys held down 
        if(heldkeys_keys){
          for(i=0; i<heldkeys_keys.length; i++){
            // is the key held down?
            let key = heldkeys_keys[i];
            if(heldkeys[key]){
              keyEvents(event.key)
            }
          }
        }

        // clear out stuff from nonheld keys
        if(event.type == "keyup" && event.key == " " || event.key == "Spacebar"){
          player.stopKillingCircle()
        }
      }

      document.body.appendChild( renderer.domElement )
    </script>

  </body>
</html>

